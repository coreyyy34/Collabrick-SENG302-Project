package nz.ac.canterbury.seng302.homehelper.unit.service;

import nz.ac.canterbury.seng302.homehelper.service.MapboxService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.client.RestTemplate;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class MapboxServiceTests {
    @Mock
    private RestTemplate restTemplate;

    private MapboxService mapboxService;

    @BeforeEach
    public void setUp() {
        this.mapboxService = new MapboxService();
        mapboxService.setRestTemplate(restTemplate);
    }

    @Test
    void mapboxServiceRequest_SuccessfulRequest_ReturnsRepsonse() {
        mapboxService.setRestTemplate(restTemplate);

        String query = "123 Main St";
        String expectedResponse = "{\"type\":\"FeatureCollection\",\"features\":[{\"type\":\"Feature\",\"id\":\"dXJuOm1ieGFkcjo1OTQ2MmM5Yi05NjhhLTRiYTYtYWM1Yy02Nzk1N2JjMTFmNjI\",\"geometry\":{\"type\":\"Point\",\"coordinates\":[150.156703,-33.481283]},\"properties\":{\"mapbox_id\":\"dXJuOm1ieGFkcjo1OTQ2MmM5Yi05NjhhLTRiYTYtYWM1Yy02Nzk1N2JjMTFmNjI\",\"feature_type\":\"address\",\"full_address\":\"123 Main Street West, Lithgow New South Wales 2790, Australia\",\"name\":\"123 Main Street West\",\"name_preferred\":\"123 Main Street West\",\"coordinates\":{\"longitude\":150.156703,\"latitude\":-33.481283,\"accuracy\":\"rooftop\",\"routable_points\":[{\"name\":\"default\",\"latitude\":-33.481144,\"longitude\":150.156595}]},\"place_formatted\":\"Lithgow New South Wales 2790, Australia\",\"match_code\":{\"address_number\":\"matched\",\"street\":\"unmatched\",\"postcode\":\"unmatched\",\"place\":\"unmatched\",\"region\":\"unmatched\",\"locality\":\"not_applicable\",\"country\":\"inferred\",\"confidence\":\"low\"},\"context\":{\"address\":{\"mapbox_id\":\"dXJuOm1ieGFkcjo1OTQ2MmM5Yi05NjhhLTRiYTYtYWM1Yy02Nzk1N2JjMTFmNjI\",\"address_number\":\"123\",\"street_name\":\"Main Street West\",\"name\":\"123 Main Street West\"},\"street\":{\"mapbox_id\":\"dXJuOm1ieGFkci1zdHI6NTk0NjJjOWItOTY4YS00YmE2LWFjNWMtNjc5NTdiYzExZjYy\",\"name\":\"Main Street West\"},\"postcode\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpTazRP\",\"name\":\"2790\"},\"place\":{\"mapbox_id\":\"dXJuOm1ieHBsYzo1YWdP\",\"name\":\"Lithgow\",\"wikidata_id\":\"Q1789805\"},\"region\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpoQTQ\",\"name\":\"New South Wales\",\"wikidata_id\":\"Q3224\",\"region_code\":\"NSW\",\"region_code_full\":\"AU-NSW\"},\"country\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpJZzQ\",\"name\":\"Australia\",\"wikidata_id\":\"Q408\",\"country_code\":\"AU\",\"country_code_alpha_3\":\"AUS\"}}}},{\"type\":\"Feature\",\"id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6MQ\",\"geometry\":{\"type\":\"Point\",\"coordinates\":[152.545542,-32.072613]},\"properties\":{\"mapbox_id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6MQ\",\"feature_type\":\"address\",\"full_address\":\"123 Main Street, Black Head New South Wales 2430, Australia\",\"name\":\"123 Main Street\",\"name_preferred\":\"123 Main Street\",\"coordinates\":{\"longitude\":152.545542,\"latitude\":-32.072613,\"accuracy\":\"interpolated\",\"routable_points\":[{\"name\":\"default\",\"latitude\":-32.072613,\"longitude\":152.545542}]},\"place_formatted\":\"Black Head New South Wales 2430, Australia\",\"match_code\":{\"address_number\":\"plausible\",\"street\":\"matched\",\"postcode\":\"unmatched\",\"place\":\"unmatched\",\"region\":\"unmatched\",\"locality\":\"not_applicable\",\"country\":\"inferred\",\"confidence\":\"low\"},\"context\":{\"address\":{\"mapbox_id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6MQ\",\"address_number\":\"123\",\"street_name\":\"Main Street\",\"name\":\"123 Main Street\"},\"street\":{\"mapbox_id\":\"dXJuOm1ieGFkci1zdHItaXRwOmV5SnhJam9pTVRJeklFMWhhVzRnVTNRaUxDSnNhVzFwZENJNklqVWlMQ0pwYm1Oc2RXUmxYMjFoZEdOb1gyUmxkR0ZwYkNJNkluUnlkV1VpTENKdGIyUmxJam9pWm05eWQyRnlaQ0o5OjE\",\"name\":\"Main Street\"},\"postcode\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpMRTRP\",\"name\":\"2430\"},\"place\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpBallJRGc\",\"name\":\"Black Head\",\"wikidata_id\":\"Q54340705\"},\"region\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpoQTQ\",\"name\":\"New South Wales\",\"wikidata_id\":\"Q3224\",\"region_code\":\"NSW\",\"region_code_full\":\"AU-NSW\"},\"country\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpJZzQ\",\"name\":\"Australia\",\"wikidata_id\":\"Q408\",\"country_code\":\"AU\",\"country_code_alpha_3\":\"AUS\"}}}},{\"type\":\"Feature\",\"id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6Mg\",\"geometry\":{\"type\":\"Point\",\"coordinates\":[150.908565,-33.769663]},\"properties\":{\"mapbox_id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6Mg\",\"feature_type\":\"address\",\"full_address\":\"123 Main Street, Blacktown New South Wales 2148, Australia\",\"name\":\"123 Main Street\",\"name_preferred\":\"123 Main Street\",\"coordinates\":{\"longitude\":150.908565,\"latitude\":-33.769663,\"accuracy\":\"interpolated\",\"routable_points\":[{\"name\":\"default\",\"latitude\":-33.769663,\"longitude\":150.908565}]},\"place_formatted\":\"Blacktown New South Wales 2148, Australia\",\"match_code\":{\"address_number\":\"plausible\",\"street\":\"matched\",\"postcode\":\"unmatched\",\"place\":\"unmatched\",\"region\":\"unmatched\",\"locality\":\"not_applicable\",\"country\":\"inferred\",\"confidence\":\"low\"},\"context\":{\"address\":{\"mapbox_id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6Mg\",\"address_number\":\"123\",\"street_name\":\"Main Street\",\"name\":\"123 Main Street\"},\"street\":{\"mapbox_id\":\"dXJuOm1ieGFkci1zdHItaXRwOmV5SnhJam9pTVRJeklFMWhhVzRnVTNRaUxDSnNhVzFwZENJNklqVWlMQ0pwYm1Oc2RXUmxYMjFoZEdOb1gyUmxkR0ZwYkNJNkluUnlkV1VpTENKdGIyUmxJam9pWm05eWQyRnlaQ0o5OjI\",\"name\":\"Main Street\"},\"postcode\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpFNjRP\",\"name\":\"2148\"},\"locality\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpEM0FxRGc\",\"name\":\"Blacktown\",\"wikidata_id\":\"Q4216448\"},\"place\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpBWFhJRGc\",\"name\":\"Sydney\",\"wikidata_id\":\"Q3130\"},\"region\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpoQTQ\",\"name\":\"New South Wales\",\"wikidata_id\":\"Q3224\",\"region_code\":\"NSW\",\"region_code_full\":\"AU-NSW\"},\"country\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpJZzQ\",\"name\":\"Australia\",\"wikidata_id\":\"Q408\",\"country_code\":\"AU\",\"country_code_alpha_3\":\"AUS\"}}}},{\"type\":\"Feature\",\"id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6Mw\",\"geometry\":{\"type\":\"Point\",\"coordinates\":[150.868222,-32.053564]},\"properties\":{\"mapbox_id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6Mw\",\"feature_type\":\"address\",\"full_address\":\"123 Main Street, Scone New South Wales 2337, Australia\",\"name\":\"123 Main Street\",\"name_preferred\":\"123 Main Street\",\"coordinates\":{\"longitude\":150.868222,\"latitude\":-32.053564,\"accuracy\":\"interpolated\",\"routable_points\":[{\"name\":\"default\",\"latitude\":-32.053564,\"longitude\":150.868222}]},\"place_formatted\":\"Scone New South Wales 2337, Australia\",\"match_code\":{\"address_number\":\"plausible\",\"street\":\"matched\",\"postcode\":\"unmatched\",\"place\":\"unmatched\",\"region\":\"unmatched\",\"locality\":\"not_applicable\",\"country\":\"inferred\",\"confidence\":\"low\"},\"context\":{\"address\":{\"mapbox_id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6Mw\",\"address_number\":\"123\",\"street_name\":\"Main Street\",\"name\":\"123 Main Street\"},\"street\":{\"mapbox_id\":\"dXJuOm1ieGFkci1zdHItaXRwOmV5SnhJam9pTVRJeklFMWhhVzRnVTNRaUxDSnNhVzFwZENJNklqVWlMQ0pwYm1Oc2RXUmxYMjFoZEdOb1gyUmxkR0ZwYkNJNkluUnlkV1VpTENKdGIyUmxJam9pWm05eWQyRnlaQ0o5OjM\",\"name\":\"Main Street\"},\"postcode\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpKSTRP\",\"name\":\"2337\"},\"place\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpBVjdvRGc\",\"name\":\"Scone\",\"wikidata_id\":\"Q1026207\"},\"region\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpoQTQ\",\"name\":\"New South Wales\",\"wikidata_id\":\"Q3224\",\"region_code\":\"NSW\",\"region_code_full\":\"AU-NSW\"},\"country\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpJZzQ\",\"name\":\"Australia\",\"wikidata_id\":\"Q408\",\"country_code\":\"AU\",\"country_code_alpha_3\":\"AUS\"}}}},{\"type\":\"Feature\",\"id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6NA\",\"geometry\":{\"type\":\"Point\",\"coordinates\":[150.756758,-34.048979]},\"properties\":{\"mapbox_id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6NA\",\"feature_type\":\"address\",\"full_address\":\"123 Main Street, Mount Annan New South Wales 2567, Australia\",\"name\":\"123 Main Street\",\"name_preferred\":\"123 Main Street\",\"coordinates\":{\"longitude\":150.756758,\"latitude\":-34.048979,\"accuracy\":\"interpolated\",\"routable_points\":[{\"name\":\"default\",\"latitude\":-34.048979,\"longitude\":150.756758}]},\"place_formatted\":\"Mount Annan New South Wales 2567, Australia\",\"match_code\":{\"address_number\":\"plausible\",\"street\":\"matched\",\"postcode\":\"unmatched\",\"place\":\"unmatched\",\"region\":\"unmatched\",\"locality\":\"not_applicable\",\"country\":\"inferred\",\"confidence\":\"low\"},\"context\":{\"address\":{\"mapbox_id\":\"dXJuOm1ieGFkci1pdHA6ZXlKeElqb2lNVEl6SUUxaGFXNGdVM1FpTENKc2FXMXBkQ0k2SWpVaUxDSnBibU5zZFdSbFgyMWhkR05vWDJSbGRHRnBiQ0k2SW5SeWRXVWlMQ0p0YjJSbElqb2labTl5ZDJGeVpDSjk6NA\",\"address_number\":\"123\",\"street_name\":\"Main Street\",\"name\":\"123 Main Street\"},\"street\":{\"mapbox_id\":\"dXJuOm1ieGFkci1zdHItaXRwOmV5SnhJam9pTVRJeklFMWhhVzRnVTNRaUxDSnNhVzFwZENJNklqVWlMQ0pwYm1Oc2RXUmxYMjFoZEdOb1gyUmxkR0ZwYkNJNkluUnlkV1VpTENKdGIyUmxJam9pWm05eWQyRnlaQ0o5OjQ\",\"name\":\"Main Street\"},\"postcode\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpOeTRP\",\"name\":\"2567\"},\"locality\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpFQ0FLRGc\",\"name\":\"Mount Annan\",\"wikidata_id\":\"Q6919413\"},\"place\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpBWFhJRGc\",\"name\":\"Sydney\",\"wikidata_id\":\"Q3130\"},\"region\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpoQTQ\",\"name\":\"New South Wales\",\"wikidata_id\":\"Q3224\",\"region_code\":\"NSW\",\"region_code_full\":\"AU-NSW\"},\"country\":{\"mapbox_id\":\"dXJuOm1ieHBsYzpJZzQ\",\"name\":\"Australia\",\"wikidata_id\":\"Q408\",\"country_code\":\"AU\",\"country_code_alpha_3\":\"AUS\"}}}}],\"attribution\":\"NOTICE: © 2025 Mapbox and its suppliers. All rights reserved. Use of this data is subject to the Mapbox Terms of Service (https://www.mapbox.com/about/maps/). This response and the information it contains may not be retained.\"}\n";
        double lat = -40.9006; // Default Latitude for New Zealand
        double lon = 174.8860; // Default Longitude for New Zealand

        when(restTemplate.getForEntity(anyString(), eq(String.class)))
                .thenReturn(new ResponseEntity<>(expectedResponse, HttpStatus.OK));

        String result = mapboxService.autocomplete(query, lat, lon);

        assertEquals(expectedResponse, result);
    }

    @Test
    void mapboxServiceRequest_UnsuccessfulRequest_ReturnsErrorResponse() {
        mapboxService.setRestTemplate(restTemplate);

        String query = "123 Main St";
        String expectedResponse = "{\"error\":\"Request failed\"}";
        double lat = -40.9006; // Default Latitude for New Zealand
        double lon = 174.8860; // Default Longitude for New Zealand

        when(restTemplate.getForEntity(anyString(), eq(String.class)))
                .thenReturn(new ResponseEntity<>(expectedResponse, HttpStatus.OK));

        String result = mapboxService.autocomplete(query, lat, lon);

        assertEquals(expectedResponse, result);
    }
}
